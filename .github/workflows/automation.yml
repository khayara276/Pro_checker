name: Continuous Automation Monitor

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '*/5 * * * *'  # Check every 5 minutes for restart
  push:
    branches: [ main ]

jobs:
  automation-engine:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5 hours 50 minutes

    # Prevent concurrent runs
    concurrency:
      group: automation-monitor
      cancel-in-progress: false

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì• Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3 DrissionPage playwright
          playwright install chromium
          playwright install-deps chromium

      - name: üöÄ Start Automation Engine
        id: engine_run
        continue-on-error: true
        env:
          TOKEN_CHANNEL_A: ${{ secrets.TOKEN_CHANNEL_A }}
          TOKEN_CHANNEL_B: ${{ secrets.TOKEN_CHANNEL_B }}
          TARGET_CHAT: ${{ secrets.TARGET_CHAT }}
          AUTH_DATA: ${{ secrets.AUTH_DATA }}
          BASE_DOMAIN: ${{ secrets.BASE_DOMAIN }}
          ENDPOINT_CATEGORY_A: ${{ secrets.ENDPOINT_CATEGORY_A }}
          ENDPOINT_CATEGORY_B: ${{ secrets.ENDPOINT_CATEGORY_B }}
          ENDPOINT_CATEGORY_C: ${{ secrets.ENDPOINT_CATEGORY_C }}
        run: |
          echo "üî• Engine starting at $(date)"
          python automation_engine.py
          ENGINE_EXIT_CODE=$?
          echo "exit_code=$ENGINE_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "‚è∏Ô∏è  Engine stopped at $(date) with exit code $ENGINE_EXIT_CODE"

      - name: üîÑ Auto-Restart Logic
        if: always()
        run: |
          EXIT_CODE="${{ steps.engine_run.outputs.exit_code }}"
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "Analyzing exit scenario..."
          echo "Exit Code: $EXIT_CODE"
          echo "Workflow Trigger: ${{ github.event_name }}"

          # Check if this was a timeout (exit code 124 or workflow timeout)
          if [ "${{ job.status }}" == "cancelled" ] || [ "$EXIT_CODE" == "124" ]; then
            echo "‚è∞ Detected GitHub timeout - Triggering automatic restart"

            # Trigger a new workflow run
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "${{ github.api_url }}/repos/${{ github.repository }}/actions/workflows/automation.yml/dispatches" \
              -d '{"ref":"${{ github.ref }}"}'

            echo "‚úÖ Restart triggered successfully"
          else
            echo "üõë Manual stop detected - No automatic restart"
          fi

  health-check:
    runs-on: ubuntu-latest
    needs: automation-engine
    if: always()

    steps:
      - name: üìä Monitor Status
        run: |
          echo "================================"
          echo "Automation Engine Health Check"
          echo "================================"
          echo "Workflow Status: ${{ needs.automation-engine.result }}"
          echo "Timestamp: $(date)"
          echo "Run ID: ${{ github.run_id }}"
          echo "================================"
